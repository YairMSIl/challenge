<!DOCTYPE html>
<html>
    <head>
        <title>Gemini Chat Interface</title>
        <link rel="stylesheet" href="/static/css/chat.css">
        <!-- Add Font Awesome for icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    </head>
    <body>
        <h1>Gemini Chat Interface</h1>
        <div id="cost-info">
            <span>
                <i class="fas fa-coins"></i>
                <span class="cost-label">Session Cost:</span>
                <span class="cost-value">$<span id="totalCost">0.00</span></span>
            </span>
            <span>
                <i class="fas fa-wallet"></i>
                <span class="cost-label">Remaining Budget:</span>
                <span class="cost-value">$<span id="remainingBudget">25.00</span></span>
            </span>
        </div>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Type your message... (start with '/image' to generate images)">
        <button onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i> Send
        </button>
        <script>
            let ws = new WebSocket("ws://" + window.location.host + "/ws");
            let messages = document.getElementById("messages");
            let messageInput = document.getElementById("messageInput");
            let costInfo = document.getElementById("cost-info");
            let currentAudio = null;

            function updateCostDisplay(costInfo) {
                if (!costInfo) return;  // Skip update if no cost info available
                
                // Update total cost and remaining budget
                const totalCostElement = document.getElementById('totalCost');
                const remainingBudgetElement = document.getElementById('remainingBudget');
                
                // Only update if we have valid numbers
                if (typeof costInfo.total_cost === 'number') {
                    totalCostElement.textContent = costInfo.total_cost.toFixed(3);
                }
                if (typeof costInfo.remaining_budget === 'number') {
                    remainingBudgetElement.textContent = costInfo.remaining_budget.toFixed(2);
                    
                    // Add warning class if remaining budget is low
                    if (costInfo.remaining_budget < 5) {
                        remainingBudgetElement.parentElement.classList.add('cost-warning');
                    } else {
                        remainingBudgetElement.parentElement.classList.remove('cost-warning');
                    }
                }
            }

            function appendMessage(message, isUser = false, costInfo = null, agentFlow = null) {
                const messageDiv = document.createElement("div");
                messageDiv.className = isUser ? "message user" : "message bot";
                
                // Create message content
                const messageContent = document.createElement("div");
                messageContent.className = "message-content";
                messageContent.innerHTML = `<strong>${isUser ? "You" : "Bot"}:</strong> ${message}`;
                messageDiv.appendChild(messageContent);
                
                // Create chips container for bot messages
                if (!isUser && (costInfo || agentFlow)) {
                    const chipsContainer = document.createElement("div");
                    chipsContainer.className = "message-chips";
                    
                    // Add cost chip if available
                    if (costInfo && costInfo.request_cost) {
                        const costChip = document.createElement("div");
                        costChip.className = "message-cost-chip";
                        costChip.innerHTML = `<i class="fas fa-coins"></i> $${costInfo.request_cost.toFixed(3)}`;
                        chipsContainer.appendChild(costChip);
                    }
                    
                    // Add agent flow chip if available
                    if (agentFlow) {
                        const flowChip = document.createElement("div");
                        flowChip.className = "agent-flow-chip collapsed";
                        
                        const flowHeader = document.createElement("div");
                        flowHeader.className = "agent-flow-header";
                        flowHeader.innerHTML = `<i class="fas fa-code-branch"></i> Agent Flow <i class="fas fa-chevron-down"></i>`;
                        
                        const flowContent = document.createElement("div");
                        flowContent.className = "agent-flow-content";
                        
                        // Format agent flow content
                        let formattedFlow = '';
                        if (agentFlow.tool_calls) {
                            agentFlow.tool_calls.forEach((call, index) => {
                                formattedFlow += `<div class="tool-call">
                                    <div class="tool-call-name">${call.name}</div>
                                    <pre>${JSON.stringify(call.parameters, null, 2)}</pre>
                                    ${call.result ? `<div class="tool-result">Result: ${call.result}</div>` : ''}
                                </div>`;
                            });
                        }
                        
                        if (agentFlow.internal_messages) {
                            agentFlow.internal_messages.forEach(msg => {
                                formattedFlow += `<div class="internal-message">${msg}</div>`;
                            });
                        }
                        
                        flowContent.innerHTML = formattedFlow || JSON.stringify(agentFlow, null, 2);
                        
                        flowChip.appendChild(flowHeader);
                        flowChip.appendChild(flowContent);
                        
                        // Add click handler for expansion
                        flowHeader.addEventListener("click", () => {
                            flowChip.classList.toggle("collapsed");
                        });
                        
                        chipsContainer.appendChild(flowChip);
                    }
                    
                    messageDiv.appendChild(chipsContainer);
                }
                
                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            }

            function appendError(title, message) {
                const errorDiv = document.createElement("div");
                errorDiv.className = "error-card";
                
                const titleDiv = document.createElement("div");
                titleDiv.className = "error-title";
                titleDiv.textContent = title;
                
                const messageDiv = document.createElement("p");
                messageDiv.className = "error-message";
                messageDiv.textContent = message;
                
                errorDiv.appendChild(titleDiv);
                errorDiv.appendChild(messageDiv);
                messages.appendChild(errorDiv);
                messages.scrollTop = messages.scrollHeight;
            }

            // Audio player functionality
            function createAudioPlayer(base64Audio) {
                const audioContainer = document.createElement("div");
                audioContainer.className = "message bot";

                const audioPlayerDiv = document.createElement("div");
                audioPlayerDiv.className = "audio-container";

                // Create audio element
                const audio = document.createElement("audio");
                audio.src = "data:audio/mp3;base64," + base64Audio;

                // Create controls container
                const controls = document.createElement("div");
                controls.className = "audio-controls";

                // Play/Pause button
                const playButton = document.createElement("button");
                playButton.innerHTML = '<i class="fas fa-play"></i> Play';
                
                // Download button
                const downloadButton = document.createElement("button");
                downloadButton.innerHTML = '<i class="fas fa-download"></i> Download';
                
                // Progress bar
                const progressContainer = document.createElement("div");
                progressContainer.className = "audio-progress";
                const progressBar = document.createElement("div");
                progressBar.className = "audio-progress-bar";
                progressContainer.appendChild(progressBar);

                // Time display
                const timeDisplay = document.createElement("div");
                timeDisplay.className = "audio-time";
                timeDisplay.textContent = "0:00 / 0:00";

                // Add all elements to controls
                controls.appendChild(playButton);
                controls.appendChild(progressContainer);
                controls.appendChild(timeDisplay);
                controls.appendChild(downloadButton);

                // Add controls to container
                audioPlayerDiv.appendChild(controls);
                audioContainer.appendChild(audioPlayerDiv);

                // Event handlers
                playButton.addEventListener("click", () => {
                    if (currentAudio && currentAudio !== audio) {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                        currentAudio.parentElement.querySelector("button").innerHTML = '<i class="fas fa-play"></i> Play';
                        currentAudio.parentElement.querySelector("button").classList.remove("playing");
                    }
                    
                    if (audio.paused) {
                        audio.play();
                        playButton.innerHTML = '<i class="fas fa-pause"></i> Pause';
                        playButton.classList.add("playing");
                        currentAudio = audio;
                    } else {
                        audio.pause();
                        playButton.innerHTML = '<i class="fas fa-play"></i> Play';
                        playButton.classList.remove("playing");
                    }
                });

                downloadButton.addEventListener("click", () => {
                    const blob = base64ToBlob(base64Audio, "audio/mp3");
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.style.display = "none";
                    a.href = url;
                    a.download = "audio_" + new Date().toISOString().slice(0,19).replace(/[-:]/g, "") + ".mp3";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                });

                // Update progress bar and time
                audio.addEventListener("timeupdate", () => {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressBar.style.width = progress + "%";
                    timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
                });

                // Click on progress bar to seek
                progressContainer.addEventListener("click", (e) => {
                    const rect = progressContainer.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    audio.currentTime = pos * audio.duration;
                });

                // Reset play button when audio ends
                audio.addEventListener("ended", () => {
                    playButton.innerHTML = '<i class="fas fa-play"></i> Play';
                    playButton.classList.remove("playing");
                    currentAudio = null;
                });

                return audioContainer;
            }

            // Helper function to format time
            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const minutes = Math.floor(seconds / 60);
                seconds = Math.floor(seconds % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            // Helper function to convert base64 to blob
            function base64ToBlob(base64, type) {
                const byteCharacters = atob(base64);
                const byteArrays = [];
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                return new Blob(byteArrays, { type: type });
            }

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Update cost information
                if (data.cost_info) {
                    updateCostDisplay(data.cost_info);
                }
                
                // Handle error messages
                if (data.message && data.message.startsWith("Error:")) {
                    const errorMessage = data.message.substring(7).trim();
                    if (errorMessage.includes("Prompt must be length")) {
                        appendError("Prompt Too Long", errorMessage);
                    } else if (errorMessage.includes("budget exceeded")) {
                        appendError("Budget Exceeded", errorMessage);
                    } else {
                        appendError("Error", errorMessage);
                    }
                    return;
                }
                
                // Handle normal messages with cost and agent flow
                if (data.message) {
                    appendMessage(data.message, false, data.cost_info, data.agent_flow);
                }
                
                // Handle images
                if (data.base64_image) {
                    const imgDiv = document.createElement("div");
                    imgDiv.className = "message bot";
                    const img = document.createElement("img");
                    img.src = "data:image/png;base64," + data.base64_image;
                    img.className = "generated-image";
                    imgDiv.appendChild(img);
                    messages.appendChild(imgDiv);
                    messages.scrollTop = messages.scrollHeight;
                }

                // Handle audio
                if (data.base64_audio) {
                    const audioPlayer = createAudioPlayer(data.base64_audio);
                    messages.appendChild(audioPlayer);
                    messages.scrollTop = messages.scrollHeight;
                }
            };

            function sendMessage() {
                var input = messageInput;
                if (input.value) {
                    appendMessage(input.value, true);
                    ws.send(input.value);
                    input.value = '';
                }
            }
            
            // Allow sending message with Enter key
            messageInput.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });
        </script>
    </body>
</html> 